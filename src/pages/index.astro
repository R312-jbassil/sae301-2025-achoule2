---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

const MATERIALS = [
  { id: 'acetate', name: 'Acétate', desc: 'Léger et durable' },
  { id: 'titanium', name: 'Titane', desc: 'Ultra-résistant' },
  { id: 'wood', name: 'Bois', desc: 'Écologique et unique' },
  { id: 'metal', name: 'Métal', desc: 'Classique et élégant' }
];
const COLORS = [
  { hex: "#000", label: "Noir" }, { hex: "#8B4513", label: "Écaille" },
  { hex: "#1e3a5f", label: "Bleu" }, { hex: "#6b7280", label: "Gris" },
  { hex: "#d1d5db", label: "Transparent" }
];
const TEMPLE_COLORS = [
  { hex: "#000", label: "Noir" }, { hex: "#d4af37", label: "Or" },
  { hex: "#c0c0c0", label: "Argent" }, { hex: "#8B4513", label: "Brun" },
  { hex: "#1e3a5f", label: "Bleu" }
];
const LENSES = [
  { hex: "#000", label: "Clear" }, { hex: "#60a5fa", label: "Bleu" },
  { hex: "#6b7280", label: "Gris" }, { hex: "#92400e", label: "Brun" },
  { hex: "#059669", label: "Vert" }
];
const DEFAULT_BRIDGE = 18;
const DEFAULT_SIZE = 52;
---

<Layout>
  <Header />
  <main class="min-h-screen flex items-stretch bg-black">
    <!-- Preview -->
    <div class="flex-1 flex flex-col justify-center items-center relative bg-gradient-to-br from-black via-neutral-900 to-black px-6">
      <div class="text-center space-y-4">
        <h2 class="text-white font-semibold uppercase tracking-[0.18em]">Votre création</h2>
        <p class="text-white/60 text-sm uppercase tracking-widest">Personnalisez votre monture</p>
        <div class="py-10">
          <div class="flex items-center justify-center" style="width:600px; height:400px; margin:auto; background:rgba(0,0,0,0.40); border-radius:16px; border:1px solid #222;" id="svgWrapper"></div>
        </div>
        <div class="mx-auto flex justify-center">
          <span class="bg-white/5 border border-white/20 rounded-full px-4 py-2 flex items-center gap-2">
            <span class="inline-block w-5 h-3 bg-gradient-to-r from-blue-600 via-white to-red-600 rounded-sm"></span>
            <span class="text-white/80 text-xs uppercase tracking-wider">Fabrication française</span>
          </span>
        </div>
      </div>
    </div>
    <!-- Configuration -->
    <div class="bg-white max-w-xl w-full px-12 py-10 flex flex-col gap-8">
      <h2 class="uppercase text-black font-semibold tracking-wider text-lg mb-4">Configuration</h2>

      <!-- Matériau Monture -->
      <div>
        <label class="block mb-1 font-bold tracking-wide uppercase text-xs">Matériau de la monture</label>
        <div class="grid grid-cols-2 gap-3" id="frameMaterial">
          {MATERIALS.map(mat => (
            <button type="button" data-material={mat.id} class="group flex-1 border rounded-md p-3 hover:border-black transition-all">
              <span class="font-semibold text-black">{mat.name}</span>
              <div class="text-xs text-black/50">{mat.desc}</div>
            </button>
          ))}
        </div>
      </div>

      <!-- Matériau Branches -->
      <div>
        <label class="block mb-1 font-bold tracking-wide uppercase text-xs">Matériau des branches</label>
        <div class="grid grid-cols-2 gap-3" id="templeMaterial">
          {MATERIALS.map(mat => (
            <button type="button" data-temple={mat.id} class="group flex-1 border rounded-md p-3 hover:border-black transition-all">
              <span class="font-semibold text-black">{mat.name}</span>
              <div class="text-xs text-black/50">{mat.desc}</div>
            </button>
          ))}
        </div>
      </div>

      <!-- Couleurs monture -->
      <div>
        <label class="block mb-2 font-bold tracking-wide uppercase text-xs">Couleur de la monture</label>
        <div class="flex gap-2" id="frameColor">
          {COLORS.map(c => (
            <button type="button" title={c.label} data-hex={c.hex} class="w-8 h-8 rounded-full border-2 border-black/20 ring-2 ring-transparent focus:ring-red-600"></button>
          ))}
        </div>
      </div>

      <!-- Couleurs branches -->
      <div>
        <label class="block mb-2 font-bold tracking-wide uppercase text-xs">Couleur des branches</label>
        <div class="flex gap-2" id="templeColor">
          {TEMPLE_COLORS.map(c => (
            <button type="button" title={c.label} data-hex={c.hex} class="w-8 h-8 rounded-full border-2 border-black/20 ring-2 ring-transparent focus:ring-red-600"></button>
          ))}
        </div>
      </div>

      <!-- Teinte verres -->
      <div>
        <label class="block mb-2 font-bold tracking-wide uppercase text-xs">Teinte des verres</label>
        <div class="flex gap-2" id="lensColor">
          {LENSES.map(t => (
            <button type="button" title={t.label} data-hex={t.hex} class="w-8 h-8 rounded-full border-2 border-black/20 ring-2 ring-transparent focus:ring-red-600"></button>
          ))}
        </div>
      </div>

      <!-- Sliders -->
      <div>
        <label class="flex justify-between font-bold tracking-wide uppercase text-xs mb-1">
          <span>Largeur du pont</span>
          <span class="font-normal text-black/60"><span id="bridgeWidth">{DEFAULT_BRIDGE}</span> mm</span>
        </label>
        <input id="bridgeInput" type="range" min="15" max="22" value={DEFAULT_BRIDGE} class="w-full accent-red-600"/>
        <div class="flex justify-between text-xs text-black/50 mt-1 uppercase">
          <span>Étroi</span>
          <span>Large</span>
        </div>
      </div>
      <div>
        <label class="flex justify-between font-bold tracking-wide uppercase text-xs mb-1">
          <span>Taille des verres</span>
          <span class="font-normal text-black/60"><span id="lensSize">{DEFAULT_SIZE}</span> mm</span>
        </label>
        <input id="sizeInput" type="range" min="48" max="58" value={DEFAULT_SIZE} class="w-full accent-red-600"/>
        <div class="flex justify-between text-xs text-black/50 mt-1 uppercase">
          <span>Petit</span>
          <span>Grand</span>
        </div>
      </div>

      <div class="mt-6">
        <button type="button" class="enregistrer w-full py-4 px-8 bg-red-600 rounded text-white font-semibold uppercase tracking-widest hover:bg-red-700 transition">
  ENREGISTRER MA CRÉATION
</button>

      </div>
    </div>
  </main>

  <script is:client>
    document.addEventListener("DOMContentLoaded", () => {
      let frameMaterial = "acetate";
      let templeMaterial = "metal";
      let frameColor = "#000000";
      let templeColor = "#000000";
      let lensColor = "#00000018";
      let bridgeWidth = 18;
      let lensSize = 52;

      function renderSVG() {
        const wrapper = document.getElementById('svgWrapper');
        if (!wrapper) return;
        wrapper.innerHTML = `
          <svg width="100%" height="100%" viewBox="0 0 595.28 350" fill="none" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" style="display:block;">
            <g id="branches">
  <!-- Branche gauche (déjà présente) -->
  <path d="M108.83,155.14s49.35-5.57,54.93-8.76,11.14-7.96,19.5-9.55,64.48-11.14,64.48-11.14c0,0,7.16-1.99,17.51,5.57s33.04,31.84,39.4,31.05c6.37-.8,9.55-9.55,7.56-13.53s-40.67-32.75-47.36-34.63c-9.53-2.68-21.89-2.39-37.02,0-15.12,2.39-116.22,23.34-116.22,23.34,0,0-13.13,6.12-2.79,17.66Z" fill="${templeColor}" stroke="#1d1d1b" stroke-width="0.5"/>
  <!-- Branche droite : ajoute les chemins SVG exacts ci-dessous -->
  <path d="M374.79,179.65l90.54-29.78s22.13-5.63,25.35-4.02,17.71,30.58,17.71,33.8-2.42,14.01-5.63,14.89c-2.33.64-5.33.11-6.84-4.21-1.41-4.02-6.84-31.73-12.47-31.47s-50.7,15.95-50.7,15.95c0,0-13.28,6.44-18.91,11.27s-32.19,11.27-32.19,11.27c0,0-9.66-7.65-6.84-17.71Z" fill="${templeColor}" stroke="#1d1d1b" stroke-width="0.5"/>
  <path d="M381.34,180.10s102.27-35.19,107.85-31.99c0,0-18.2,2.49-41.76,11.88s-66.09,22.03-66.09,22.03v-1.92Z" fill="${templeColor}" opacity="0.35"/>
  <!-- Tu peux aussi ajouter celles-ci si tu as d’autres paths pour détails -->
  <path d="M485.36,158.06s3.26,0,4.98,3.45,9.77,24.71,9.77,24.71c0,0,.77,4.98,5.17-2.68,0,0-3.07,9.56-5.36,6.79s-9.77-26.33-9.77-26.33c0,0-2.87-6.74-4.79-5.94Z" fill="${templeColor}" stroke="#1d1d1b" stroke-width="0.5"/>
</g>

			<g id="monture">
              <path d="M385.31,180.81c-.24-3.41-9.57-5.22-12.71-6.4-3.14-1.18-15.7,1.96-15.7,1.96-12.17-3.14-54.55-9.03-78.88-9.03s-32.57,11.38-35.32,10.99c-2.75-.39-17.27-.78-23.55-1.96-6.28-1.18-5.1-14.13-39.25-26.48-34.14-12.35-68.29-12.42-68.29-12.42-13.35,4.66-6.76,18.49-6.76,18.49l2.05,6.35c4.32,2.03,3.14,10.52,4.71,23.08s7.46,28.65,14.13,38.46c6.67,9.81,31.79,20.8,44.35,21.19s23.55-1.96,31.79-15.31c8.24-13.34,16.88-36.89,16.88-36.89l10.2,1.57s2.91.31,5.35,3.09,4.43,8.03,7.6,17.31c7.56,22.1,25.12,39.25,25.12,39.25,0,0,5.6,7.43,33.44,12.66,23.08,4.34,42.7-2.46,42.7-2.46,17.72-7.17,21.63-44.96,21.63-44.96,0,0,1.83-13.3,7.81-16.65,7.37-4.14,8.27-4.44,12.71-5.32,3.61-.71.24-13.13,0-16.54ZM190.5,231.32c-9.42,5.1-32.18,7.06-46.31-3.92-14.13-10.99-20.8-30.22-22.76-52.98s7.1-25.23,7.1-25.23c0,0,14.88-.67,34.11,4.03,19.23,4.71,40.42,18.05,40.82,26.69.39,8.63-3.53,46.31-12.95,51.41ZM344.73,255.65c-9.03,4.32-21.47,4.71-31.93,3.92-10.46-.78-37.54-1.57-47.35-31.4,0,0-2.75-14.13-5.1-17.27-2.35-3.14-9.42-14.48-9.42-18.43,0-8.23,7.15-12.97,7.15-12.97,0,0,8.16-5.1,18.75-5.1,10.6,0,64.75,2.75,72.21,12.95,7.46,10.2,7.06,21.98,8.24,31.4,1.18,9.42-3.53,32.57-12.56,36.89Z" fill="${frameColor}" stroke="#1d1d1b" stroke-width="0.5"/>
            </g>
            <g id="verres">
              <path d="M116.32,162.87c-.88,6.05.4,37.41,11.44,55.31s37.04,21.35,41.37,21.31,18.51,1.02,24.47-9.27c4.97-8.59,13.17-43.48,9.12-53.05-6.26-14.82-40.4-24.02-40.4-24.02,0,0-26.85-5.46-33.82-4.46,0,0-9.97-.96-12.17,14.17Z" fill="${lensColor}" opacity="0.75"/>
              <path d="M247.32,192.54s-1.09-9.55,19.57-16.69c11.76-4.06,60.46,3.23,60.46,3.23,0,0,19.09,4.06,21.71,8.28,2.62,4.22,9.46,17.24,8.29,37.97-1.14,20.21-7.31,26.8-12.61,30.31,0,0-7.1,4.93-21.34,5.93-26.65,1.88-37.01-1.14-46.19-7.73-29.88-21.46-29.88-61.3-29.88-61.3Z" fill="${lensColor}" opacity="0.75"/>
            </g>
          </svg>
        `;
      }
      renderSVG();

	  

      // Couleurs monture
      document.querySelectorAll("#frameColor button").forEach(btn => {
        btn.style.background = btn.dataset.hex;
        btn.onclick = () => {
          frameColor = btn.dataset.hex;
          renderSVG();
        };
      });

      // Couleurs branches
      document.querySelectorAll("#templeColor button").forEach(btn => {
        btn.style.background = btn.dataset.hex;
        btn.onclick = () => {
          templeColor = btn.dataset.hex;
          renderSVG();
        };
      });

      // Couleurs verres
      document.querySelectorAll("#lensColor button").forEach(btn => {
        btn.style.background = btn.dataset.hex;
        btn.onclick = () => {
          lensColor = btn.dataset.hex;
          renderSVG();
        };
      });

      // Sliders
      document.getElementById("bridgeInput").oninput = e => {
        bridgeWidth = e.target.value;
        document.getElementById("bridgeWidth").textContent = bridgeWidth;
        renderSVG();
      };
      document.getElementById("sizeInput").oninput = e => {
        lensSize = e.target.value;
        document.getElementById("lensSize").textContent = lensSize;
        renderSVG();
      };

      // Matériaux
      document.querySelectorAll("[data-material]").forEach(btn => {
        btn.onclick = () => {
          frameMaterial = btn.dataset.material;
          // Tu peux appeler renderSVG() ici si tu veux inclure ce change
        };
      });
      document.querySelectorAll("[data-temple]").forEach(btn => {
        btn.onclick = () => {
          templeMaterial = btn.dataset.temple;
          // Idem renderSVG si besoin
        };
      });

	  // Enregistrement création
document.querySelector('button.enregistrer').onclick = () => {
  const svg = document.getElementById('svgWrapper').innerHTML;
  const config = {
    svg,
    frameColor,
    templeColor,
    lensColor,
    frameMaterial,
    templeMaterial,
    bridgeWidth,
    lensSize,
    date: new Date().toISOString()
  };
  let creations = JSON.parse(localStorage.getItem('creations') || '[]');
  creations.push(config);
  localStorage.setItem('creations', JSON.stringify(creations));
  alert('Création enregistrée !');
};

    });
  </script>
<script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
<script is:client>
  const pb = new PocketBase('http://127.0.0.1:8090');

  document.getElementById('googleLogin').onclick = async () => {
    try {
      await pb.collection('utilisateur').authWithOAuth2({ provider: 'google' });
      localStorage.setItem('loggedIn', 'true');
      window.location.href = '/creations';
    } catch (e) {
      alert("Connexion Google échouée : " + e.message);
    }
  };
</script>

  <Footer />
</Layout>
